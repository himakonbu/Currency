<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>通貨ペアチャート（TradingView）</title>
<style>
  :root{
    --accent:#22c55e; --border:#e5e7eb; --card:#fff; --bg:#f6f7f9; --muted:#64748b;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif; color:#0f172a }
  .topbar{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
           background:linear-gradient(#ffffffcc,#ffffffcc); border-bottom:1px solid var(--border) }
  .topbar-inner{ max-width:980px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:12px; justify-content:space-between }
  .title{ font-weight:800 }

  .wrap{ max-width:980px; margin:16px auto 64px; padding:0 16px; display:grid; gap:16px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,.04) }
  h1{ font-size:1.1rem; margin:0 0 12px }

  .row{ display:grid; gap:12px; align-items:center }
  .row-3{ grid-template-columns:1fr 60px 1fr }
  @media (max-width:640px){ .row-3{ grid-template-columns:1fr 52px 1fr } }

  select{ width:100%; padding:14px 12px; border:1px solid var(--border); border-radius:14px; background:#fff; font-size:1rem }
  select:disabled{ background:#f8fafc; color:#94a3b8 }
  .swap{ display:flex; align-items:center; justify-content:center }
  .swap button{ width:100%; height:48px; border-radius:12px; border:0; background:#ecfdf5; color:#065f46; font-size:20px; cursor:pointer }

  #chart{ margin-top:16px }

  /* 通貨リスト */
  .list{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; margin-top:18px }
  .item{ display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
  .flag{ font-size:22px }
  .code{ font-weight:800; width:56px }
  .muted{ color:#64748b }

  /* モード切替 (Auto/PC/モバイル) */
  .seg{ display:inline-flex; gap:0; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
  .seg input{ display:none }
  .seg label{ padding:8px 12px; cursor:pointer; font-size:.9rem; user-select:none }
  .seg input:checked + label{ background:var(--accent); color:#fff }

  /* ビュー切替 (モバイル時) */
  .view-switcher{ display:none; gap:8px; margin: -4px 0 8px 0 }
  .view-switcher .seg label{ padding:8px 16px }

  /* Auto(=デフォ)はメディアクエリで制御。PC時は両カード表示、モバイル時はタブ制御 */
  @media (max-width:640px){
    body[data-mode="auto"] .view-switcher{ display:flex }
    body[data-mode="auto"][data-tab="chart"] #cardList{ display:none }
    body[data-mode="auto"][data-tab="list"]  #cardPair{ display:none }
  }

  /* 強制PC */
  body[data-mode="desktop"] .view-switcher{ display:none }
  /* 強制モバイル */
  body[data-mode="mobile"] .view-switcher{ display:flex }
  body[data-mode="mobile"][data-tab="chart"] #cardList{ display:none }
  body[data-mode="mobile"][data-tab="list"]  #cardPair{ display:none }

  /* 補助テキスト */
  .inline-note{ font-size:.85rem; color:var(--muted); margin-top:4px }
  .invalid{ padding:16px;border:1px dashed #fca5a5;border-radius:12px;background:#fff5f5;color:#b91c1c }
</style>

<div class="topbar">
  <div class="topbar-inner">
    <div class="title">📈 通貨ペアチャート</div>
    <div class="seg" id="modeSeg">
      <input type="radio" name="mode" id="m-auto" value="auto" checked><label for="m-auto">Auto</label>
      <input type="radio" name="mode" id="m-desktop" value="desktop"><label for="m-desktop">PC</label>
      <input type="radio" name="mode" id="m-mobile" value="mobile"><label for="m-mobile">モバイル</label>
    </div>
  </div>
</div>

<div class="wrap" id="wrap">
  <div class="card" id="cardPair">
    <h1>通貨を選択</h1>
    <div class="row row-3">
      <select id="base" aria-label="基軸通貨"></select>
      <div class="swap"><button id="btnSwap" title="入れ替え">↔︎</button></div>
      <select id="quote" aria-label="決済通貨"></select>
    </div>
    <div id="chart" aria-live="polite"></div>
    <div class="inline-note" id="hint" hidden></div>
  </div>

  <div class="card" id="cardList">
    <div class="view-switcher">
      <div class="seg" id="tabSeg">
        <input type="radio" name="tab" id="t-chart" value="chart" checked><label for="t-chart">チャート</label>
        <input type="radio" name="tab" id="t-list" value="list"><label for="t-list">通貨解説</label>
      </div>
    </div>
    <h1>通貨コード解説</h1>
    <div id="list" class="list"></div>
  </div>
</div>

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const currencies = [
    {code:"USD", flag:"🇺🇸", country:"アメリカ", name:"米ドル"},
    {code:"JPY", flag:"🇯🇵", country:"日本",     name:"日本円"},
    {code:"EUR", flag:"🇪🇺", country:"欧州連合", name:"ユーロ"},
    {code:"GBP", flag:"🇬🇧", country:"イギリス", name:"英ポンド"},
    {code:"AUD", flag:"🇦🇺", country:"オーストラリア", name:"豪ドル"},
    {code:"CAD", flag:"🇨🇦", country:"カナダ",   name:"カナダドル"},
    {code:"CHF", flag:"🇨🇭", country:"スイス",   name:"スイスフラン"},
    {code:"HKD", flag:"🇭🇰", country:"香港",     name:"香港ドル"},
    {code:"CNY", flag:"🇨🇳", country:"中国",     name:"人民元"},
    {code:"KRW", flag:"🇰🇷", country:"韓国",     name:"韓国ウォン"},
    {code:"BTC", flag:"₿",   country:"暗号資産", name:"ビットコイン"},
    {code:"XAU", flag:"🥇",   country:"貴金属",   name:"ゴールド（金）"}
  ];

  const $base  = document.getElementById('base');
  const $quote = document.getElementById('quote');
  const tvContainer = document.getElementById('chart');
  const $hint = document.getElementById('hint');

  // セレクト初期化
  currencies.forEach(c => {
    $base.append(new Option(c.code, c.code));
    $quote.append(new Option(c.code, c.code));
  });

  // 前回の選択を復元
  const saved = JSON.parse(localStorage.getItem('cprefs')||'{}');
  $base.value  = saved.base  || 'USD';
  $quote.value = saved.quote || 'JPY';

  // 通貨リスト描画
  document.getElementById('list').innerHTML = currencies.map(c => `
    <div class="item">
      <span class="flag">${c.flag}</span>
      <b class="code">${c.code}</b>
      <div>
        <div>${c.country}</div>
        <div class="muted">${c.name}</div>
      </div>
    </div>
  `).join("");

  function showInvalid(msg){
    tvContainer.innerHTML = `<div class="invalid">チャート無効：${msg}</div>`;
  }

  function isBTC(x){ return x==='BTC' }
  function isXAU(x){ return x==='XAU' }

  function allowedQuotesForSpecial(base){
    // BTC/XAU の相手通貨は USD と JPY のみ
    if (isBTC(base) || isXAU(base)) return ['JPY','USD'];
    return null; // 制限なし
  }

  function updateOptionConstraints(){
    const base = $base.value, quote = $quote.value;

    // まず全有効化
    [...$base.options].forEach(o=>o.disabled=false);
    [...$quote.options].forEach(o=>o.disabled=false);

    // 自分自身同士の選択は UX的に残しておき、検証で弾く（同一通貨選択時の学習目的のため）

    // 片側が BTC/XAU の場合、相手は USD/JPY のみを許可
    const qAllow = allowedQuotesForSpecial(base);
    if (qAllow){
      [...$quote.options].forEach(o=>{ o.disabled = !qAllow.includes(o.value); });
      if ($quote.options[$quote.selectedIndex].disabled){
        // 日本のユーザーなので JPY を優先、無ければ USD
        $quote.value = qAllow.includes('JPY') ? 'JPY' : 'USD';
      }
    }

    const bAllow = allowedQuotesForSpecial(quote);
    if (bAllow){
      [...$base.options].forEach(o=>{ o.disabled = !bAllow.includes(o.value); });
      if ($base.options[$base.selectedIndex].disabled){
        $base.value = bAllow.includes('JPY') ? 'JPY' : 'USD';
      }
    }
  }

  function currentSymbol(base, quote){
    if (base === quote) return null;

    // BTC 特例
    if ((base==='BTC' && quote==='JPY') || (base==='JPY' && quote==='BTC')) {
      return 'BITFLYER:BTCJPY';
    } else if ((base==='BTC' && quote==='USD') || (base==='USD' && quote==='BTC')) {
      return 'BINANCE:BTCUSDT';
    }

    // XAU 特例（JPY/USD のみ）
    if ((base==='XAU' && quote==='JPY') || (base==='JPY' && quote==='XAU')) {
      return 'OANDA:XAUJPY';
    } else if ((base==='XAU' && quote==='USD') || (base==='USD' && quote==='XAU')) {
      // ※ XAUUSD は TVC:GOLD（ドル建て金スポット、トロイオンス）を利用
      return 'TVC:GOLD';
      // 代替: 'OANDA:XAUUSD' に差し替え可
    }

    // 通常ペア（BTC/XAU が絡まない）
    if (base!=='BTC' && quote!=='BTC' && base!=='XAU' && quote!=='XAU') {
      return `FX_IDC:${base}${quote}`;
    }

    return null;
  }

  function renderChart(){
    const base = $base.value, quote = $quote.value;
    updateOptionConstraints();

    const sym = currentSymbol(base, quote);
    if (!sym){
      showInvalid(base===quote ? '同じ通貨ペアは選べません' : 'この通貨ペアは対応していません');
      $hint.hidden = true;
    } else {
      tvContainer.innerHTML = '';
      new TradingView.widget({
        container_id: 'chart',
        symbol: sym,
        interval: '60',
        width: '100%',
        height: 440,
        locale: 'ja',
        theme: 'light'
      });

      // XAU のときだけ静かな補助ヒント（表示は控えめ）
      if (base==='XAU' || quote==='XAU'){
        $hint.textContent = 'XAU は金のトロイオンス建て（JPY は円/オンス、USD はドル/オンス）';
        $hint.hidden = true; // 既定で非表示（必要なら true→false）
      } else {
        $hint.hidden = true;
      }
    }

    // 保存
    localStorage.setItem('cprefs', JSON.stringify({ base, quote, mode: document.body.dataset.mode, tab: document.body.dataset.tab }));
  }

  // 初期表示
  updateOptionConstraints();
  renderChart();

  $base.addEventListener('change', renderChart);
  $quote.addEventListener('change', renderChart);
  document.getElementById('btnSwap').addEventListener('click', () => {
    const tmp = $base.value; $base.value = $quote.value; $quote.value = tmp;
    renderChart();
  });

  // ===== UI モード / タブ制御 =====
  const modeSeg = document.getElementById('modeSeg');
  const tabSeg  = document.getElementById('tabSeg');

  function applyMode(mode){
    document.body.dataset.mode = mode; // 'auto' | 'desktop' | 'mobile'
  }
  function applyTab(tab){ document.body.dataset.tab = tab; }

  // 復元
  applyMode(saved.mode || 'auto');
  applyTab(saved.tab || 'chart');
  if (saved.mode){
    const id = saved.mode==='desktop' ? 'm-desktop' : saved.mode==='mobile' ? 'm-mobile' : 'm-auto';
    const el = document.getElementById(id); if (el) el.checked = true;
  }
  if (saved.tab){
    const id = saved.tab==='list' ? 't-list' : 't-chart';
    const el = document.getElementById(id); if (el) el.checked = true;
  }

  modeSeg.addEventListener('change', (e)=>{
    const mode = modeSeg.querySelector('input:checked')?.value || 'auto';
    applyMode(mode);
    renderChart();
  });

  tabSeg.addEventListener('change', ()=>{
    const tab = tabSeg.querySelector('input:checked')?.value || 'chart';
    applyTab(tab);
    localStorage.setItem('cprefs', JSON.stringify({ ...JSON.parse(localStorage.getItem('cprefs')||'{}'), tab }));
  });

  // Auto のときは画面幅でタブ表示/非表示を切り替えるため、リサイズ時にも再描画
  window.addEventListener('resize', ()=>{
    if ((document.body.dataset.mode||'auto')==='auto'){
      // レイアウトだけ変わる可能性があるが、念のため再描画
      renderChart();
    }
  });
</script>
</html>
