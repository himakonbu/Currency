<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>é€šè²¨ãƒšã‚¢ãƒãƒ£ãƒ¼ãƒˆï¼ˆTradingViewï¼‰</title>
<style>
  :root{
    --accent:#22c55e; --border:#e5e7eb; --card:#fff; --bg:#f6f7f9; --muted:#64748b;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif; color:#0f172a }
  .topbar{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
           background:linear-gradient(#ffffffcc,#ffffffcc); border-bottom:1px solid var(--border) }
  .topbar-inner{ max-width:980px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:12px; justify-content:space-between }
  .title{ font-weight:800 }

  .wrap{ max-width:980px; margin:16px auto 64px; padding:0 16px; display:grid; gap:16px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,.04) }
  h1{ font-size:1.1rem; margin:0 0 12px }

  .row{ display:grid; gap:12px; align-items:center }
  .row-3{ grid-template-columns:1fr 60px 1fr }
  @media (max-width:640px){ .row-3{ grid-template-columns:1fr 52px 1fr } }

  select{ width:100%; padding:14px 12px; border:1px solid var(--border); border-radius:14px; background:#fff; font-size:1rem }
  select:disabled{ background:#f8fafc; color:#94a3b8 }
  .swap{ display:flex; align-items:center; justify-content:center }
  .swap button{ width:100%; height:48px; border-radius:12px; border:0; background:#ecfdf5; color:#065f46; font-size:20px; cursor:pointer }

  #chart{ margin-top:16px }

  /* é€šè²¨ãƒªã‚¹ãƒˆ */
  .list{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; margin-top:18px }
  .item{ display:flex; gap:10px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff }
  .flag{ font-size:22px }
  .code{ font-weight:800; width:56px }
  .muted{ color:#64748b }

  /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (Auto/PC/ãƒ¢ãƒã‚¤ãƒ«) */
  .seg{ display:inline-flex; gap:0; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff }
  .seg input{ display:none }
  .seg label{ padding:8px 12px; cursor:pointer; font-size:.9rem; user-select:none }
  .seg input:checked + label{ background:var(--accent); color:#fff }

  /* ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ (ãƒ¢ãƒã‚¤ãƒ«æ™‚) */
  .view-switcher{ display:none; gap:8px; margin: -4px 0 8px 0 }
  .view-switcher .seg label{ padding:8px 16px }

  /* Auto(=ãƒ‡ãƒ•ã‚©)ã¯ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã§åˆ¶å¾¡ã€‚PCæ™‚ã¯ä¸¡ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã€ãƒ¢ãƒã‚¤ãƒ«æ™‚ã¯ã‚¿ãƒ–åˆ¶å¾¡ */
  @media (max-width:640px){
    body[data-mode="auto"] .view-switcher{ display:flex }
    body[data-mode="auto"][data-tab="chart"] #cardList{ display:none }
    body[data-mode="auto"][data-tab="list"]  #cardPair{ display:none }
  }

  /* å¼·åˆ¶PC */
  body[data-mode="desktop"] .view-switcher{ display:none }
  /* å¼·åˆ¶ãƒ¢ãƒã‚¤ãƒ« */
  body[data-mode="mobile"] .view-switcher{ display:flex }
  body[data-mode="mobile"][data-tab="chart"] #cardList{ display:none }
  body[data-mode="mobile"][data-tab="list"]  #cardPair{ display:none }

  /* è£œåŠ©ãƒ†ã‚­ã‚¹ãƒˆ */
  .inline-note{ font-size:.85rem; color:var(--muted); margin-top:4px }
  .invalid{ padding:16px;border:1px dashed #fca5a5;border-radius:12px;background:#fff5f5;color:#b91c1c }
</style>

<div class="topbar">
  <div class="topbar-inner">
    <div class="title">ğŸ“ˆ é€šè²¨ãƒšã‚¢ãƒãƒ£ãƒ¼ãƒˆ</div>
    <div class="seg" id="modeSeg">
      <input type="radio" name="mode" id="m-auto" value="auto" checked><label for="m-auto">Auto</label>
      <input type="radio" name="mode" id="m-desktop" value="desktop"><label for="m-desktop">PC</label>
      <input type="radio" name="mode" id="m-mobile" value="mobile"><label for="m-mobile">ãƒ¢ãƒã‚¤ãƒ«</label>
    </div>
  </div>
</div>

<div class="wrap" id="wrap">
  <div class="card" id="cardPair">
    <h1>é€šè²¨ã‚’é¸æŠ</h1>
    <div class="row row-3">
      <select id="base" aria-label="åŸºè»¸é€šè²¨"></select>
      <div class="swap"><button id="btnSwap" title="å…¥ã‚Œæ›¿ãˆ">â†”ï¸</button></div>
      <select id="quote" aria-label="æ±ºæ¸ˆé€šè²¨"></select>
    </div>
    <div id="chart" aria-live="polite"></div>
    <div class="inline-note" id="hint" hidden></div>
  </div>

  <div class="card" id="cardList">
    <div class="view-switcher">
      <div class="seg" id="tabSeg">
        <input type="radio" name="tab" id="t-chart" value="chart" checked><label for="t-chart">ãƒãƒ£ãƒ¼ãƒˆ</label>
        <input type="radio" name="tab" id="t-list" value="list"><label for="t-list">é€šè²¨è§£èª¬</label>
      </div>
    </div>
    <h1>é€šè²¨ã‚³ãƒ¼ãƒ‰è§£èª¬</h1>
    <div id="list" class="list"></div>
  </div>
</div>

<!-- TradingView -->
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
  const currencies = [
    {code:"USD", flag:"ğŸ‡ºğŸ‡¸", country:"ã‚¢ãƒ¡ãƒªã‚«", name:"ç±³ãƒ‰ãƒ«"},
    {code:"JPY", flag:"ğŸ‡¯ğŸ‡µ", country:"æ—¥æœ¬",     name:"æ—¥æœ¬å††"},
    {code:"EUR", flag:"ğŸ‡ªğŸ‡º", country:"æ¬§å·é€£åˆ", name:"ãƒ¦ãƒ¼ãƒ­"},
    {code:"GBP", flag:"ğŸ‡¬ğŸ‡§", country:"ã‚¤ã‚®ãƒªã‚¹", name:"è‹±ãƒãƒ³ãƒ‰"},
    {code:"AUD", flag:"ğŸ‡¦ğŸ‡º", country:"ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢", name:"è±ªãƒ‰ãƒ«"},
    {code:"CAD", flag:"ğŸ‡¨ğŸ‡¦", country:"ã‚«ãƒŠãƒ€",   name:"ã‚«ãƒŠãƒ€ãƒ‰ãƒ«"},
    {code:"CHF", flag:"ğŸ‡¨ğŸ‡­", country:"ã‚¹ã‚¤ã‚¹",   name:"ã‚¹ã‚¤ã‚¹ãƒ•ãƒ©ãƒ³"},
    {code:"HKD", flag:"ğŸ‡­ğŸ‡°", country:"é¦™æ¸¯",     name:"é¦™æ¸¯ãƒ‰ãƒ«"},
    {code:"CNY", flag:"ğŸ‡¨ğŸ‡³", country:"ä¸­å›½",     name:"äººæ°‘å…ƒ"},
    {code:"KRW", flag:"ğŸ‡°ğŸ‡·", country:"éŸ“å›½",     name:"éŸ“å›½ã‚¦ã‚©ãƒ³"},
    {code:"BTC", flag:"â‚¿",   country:"æš—å·è³‡ç”£", name:"ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³"},
    {code:"XAU", flag:"ğŸ¥‡",   country:"è²´é‡‘å±",   name:"ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆé‡‘ï¼‰"}
  ];

  const $base  = document.getElementById('base');
  const $quote = document.getElementById('quote');
  const tvContainer = document.getElementById('chart');
  const $hint = document.getElementById('hint');

  // ã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–
  currencies.forEach(c => {
    $base.append(new Option(c.code, c.code));
    $quote.append(new Option(c.code, c.code));
  });

  // å‰å›ã®é¸æŠã‚’å¾©å…ƒ
  const saved = JSON.parse(localStorage.getItem('cprefs')||'{}');
  $base.value  = saved.base  || 'USD';
  $quote.value = saved.quote || 'JPY';

  // é€šè²¨ãƒªã‚¹ãƒˆæç”»
  document.getElementById('list').innerHTML = currencies.map(c => `
    <div class="item">
      <span class="flag">${c.flag}</span>
      <b class="code">${c.code}</b>
      <div>
        <div>${c.country}</div>
        <div class="muted">${c.name}</div>
      </div>
    </div>
  `).join("");

  function showInvalid(msg){
    tvContainer.innerHTML = `<div class="invalid">ãƒãƒ£ãƒ¼ãƒˆç„¡åŠ¹ï¼š${msg}</div>`;
  }

  function isBTC(x){ return x==='BTC' }
  function isXAU(x){ return x==='XAU' }

  function allowedQuotesForSpecial(base){
    // BTC/XAU ã®ç›¸æ‰‹é€šè²¨ã¯ USD ã¨ JPY ã®ã¿
    if (isBTC(base) || isXAU(base)) return ['JPY','USD'];
    return null; // åˆ¶é™ãªã—
  }

  function updateOptionConstraints(){
    const base = $base.value, quote = $quote.value;

    // ã¾ãšå…¨æœ‰åŠ¹åŒ–
    [...$base.options].forEach(o=>o.disabled=false);
    [...$quote.options].forEach(o=>o.disabled=false);

    // è‡ªåˆ†è‡ªèº«åŒå£«ã®é¸æŠã¯ UXçš„ã«æ®‹ã—ã¦ãŠãã€æ¤œè¨¼ã§å¼¾ãï¼ˆåŒä¸€é€šè²¨é¸æŠæ™‚ã®å­¦ç¿’ç›®çš„ã®ãŸã‚ï¼‰

    // ç‰‡å´ãŒ BTC/XAU ã®å ´åˆã€ç›¸æ‰‹ã¯ USD/JPY ã®ã¿ã‚’è¨±å¯
    const qAllow = allowedQuotesForSpecial(base);
    if (qAllow){
      [...$quote.options].forEach(o=>{ o.disabled = !qAllow.includes(o.value); });
      if ($quote.options[$quote.selectedIndex].disabled){
        // æ—¥æœ¬ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã®ã§ JPY ã‚’å„ªå…ˆã€ç„¡ã‘ã‚Œã° USD
        $quote.value = qAllow.includes('JPY') ? 'JPY' : 'USD';
      }
    }

    const bAllow = allowedQuotesForSpecial(quote);
    if (bAllow){
      [...$base.options].forEach(o=>{ o.disabled = !bAllow.includes(o.value); });
      if ($base.options[$base.selectedIndex].disabled){
        $base.value = bAllow.includes('JPY') ? 'JPY' : 'USD';
      }
    }
  }

  function currentSymbol(base, quote){
    if (base === quote) return null;

    // BTC ç‰¹ä¾‹
    if ((base==='BTC' && quote==='JPY') || (base==='JPY' && quote==='BTC')) {
      return 'BITFLYER:BTCJPY';
    } else if ((base==='BTC' && quote==='USD') || (base==='USD' && quote==='BTC')) {
      return 'BINANCE:BTCUSDT';
    }

    // XAU ç‰¹ä¾‹ï¼ˆJPY/USD ã®ã¿ï¼‰
    if ((base==='XAU' && quote==='JPY') || (base==='JPY' && quote==='XAU')) {
      return 'OANDA:XAUJPY';
    } else if ((base==='XAU' && quote==='USD') || (base==='USD' && quote==='XAU')) {
      // â€» XAUUSD ã¯ TVC:GOLDï¼ˆãƒ‰ãƒ«å»ºã¦é‡‘ã‚¹ãƒãƒƒãƒˆã€ãƒˆãƒ­ã‚¤ã‚ªãƒ³ã‚¹ï¼‰ã‚’åˆ©ç”¨
      return 'TVC:GOLD';
      // ä»£æ›¿: 'OANDA:XAUUSD' ã«å·®ã—æ›¿ãˆå¯
    }

    // é€šå¸¸ãƒšã‚¢ï¼ˆBTC/XAU ãŒçµ¡ã¾ãªã„ï¼‰
    if (base!=='BTC' && quote!=='BTC' && base!=='XAU' && quote!=='XAU') {
      return `FX_IDC:${base}${quote}`;
    }

    return null;
  }

  function renderChart(){
    const base = $base.value, quote = $quote.value;
    updateOptionConstraints();

    const sym = currentSymbol(base, quote);
    if (!sym){
      showInvalid(base===quote ? 'åŒã˜é€šè²¨ãƒšã‚¢ã¯é¸ã¹ã¾ã›ã‚“' : 'ã“ã®é€šè²¨ãƒšã‚¢ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      $hint.hidden = true;
    } else {
      tvContainer.innerHTML = '';
      new TradingView.widget({
        container_id: 'chart',
        symbol: sym,
        interval: '60',
        width: '100%',
        height: 440,
        locale: 'ja',
        theme: 'light'
      });

      // XAU ã®ã¨ãã ã‘é™ã‹ãªè£œåŠ©ãƒ’ãƒ³ãƒˆï¼ˆè¡¨ç¤ºã¯æ§ãˆã‚ï¼‰
      if (base==='XAU' || quote==='XAU'){
        $hint.textContent = 'XAU ã¯é‡‘ã®ãƒˆãƒ­ã‚¤ã‚ªãƒ³ã‚¹å»ºã¦ï¼ˆJPY ã¯å††/ã‚ªãƒ³ã‚¹ã€USD ã¯ãƒ‰ãƒ«/ã‚ªãƒ³ã‚¹ï¼‰';
        $hint.hidden = true; // æ—¢å®šã§éè¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰ trueâ†’falseï¼‰
      } else {
        $hint.hidden = true;
      }
    }

    // ä¿å­˜
    localStorage.setItem('cprefs', JSON.stringify({ base, quote, mode: document.body.dataset.mode, tab: document.body.dataset.tab }));
  }

  // åˆæœŸè¡¨ç¤º
  updateOptionConstraints();
  renderChart();

  $base.addEventListener('change', renderChart);
  $quote.addEventListener('change', renderChart);
  document.getElementById('btnSwap').addEventListener('click', () => {
    const tmp = $base.value; $base.value = $quote.value; $quote.value = tmp;
    renderChart();
  });

  // ===== UI ãƒ¢ãƒ¼ãƒ‰ / ã‚¿ãƒ–åˆ¶å¾¡ =====
  const modeSeg = document.getElementById('modeSeg');
  const tabSeg  = document.getElementById('tabSeg');

  function applyMode(mode){
    document.body.dataset.mode = mode; // 'auto' | 'desktop' | 'mobile'
  }
  function applyTab(tab){ document.body.dataset.tab = tab; }

  // å¾©å…ƒ
  applyMode(saved.mode || 'auto');
  applyTab(saved.tab || 'chart');
  if (saved.mode){
    const id = saved.mode==='desktop' ? 'm-desktop' : saved.mode==='mobile' ? 'm-mobile' : 'm-auto';
    const el = document.getElementById(id); if (el) el.checked = true;
  }
  if (saved.tab){
    const id = saved.tab==='list' ? 't-list' : 't-chart';
    const el = document.getElementById(id); if (el) el.checked = true;
  }

  modeSeg.addEventListener('change', (e)=>{
    const mode = modeSeg.querySelector('input:checked')?.value || 'auto';
    applyMode(mode);
    renderChart();
  });

  tabSeg.addEventListener('change', ()=>{
    const tab = tabSeg.querySelector('input:checked')?.value || 'chart';
    applyTab(tab);
    localStorage.setItem('cprefs', JSON.stringify({ ...JSON.parse(localStorage.getItem('cprefs')||'{}'), tab }));
  });

  // Auto ã®ã¨ãã¯ç”»é¢å¹…ã§ã‚¿ãƒ–è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã€ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚‚å†æç”»
  window.addEventListener('resize', ()=>{
    if ((document.body.dataset.mode||'auto')==='auto'){
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã ã‘å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€å¿µã®ãŸã‚å†æç”»
      renderChart();
    }
  });
</script>
</html>
